<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ID Scanner">
    <link rel="manifest" href="manifest.json">
    <title>ID Verification System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .camera-section {
            text-align: center;
            margin-bottom: 20px;
        }

        #video {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border-radius: 15px;
            background: #f0f0f0;
            object-fit: cover;
            display: none;
        }

        #canvas {
            display: none;
        }

        .camera-placeholder {
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1rem;
            border: 2px dashed #ccc;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .result.valid {
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc8 100%);
            color: #2e7d32;
        }

        .result.invalid {
            background: linear-gradient(135deg, #ffcdd2 0%, #f8bbd9 100%);
            color: #c62828;
        }

        .result.warning {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #ef6c00;
        }

        .checks {
            margin-top: 20px;
        }

        .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .check-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .check-pass {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .check-fail {
            background: #ffebee;
            color: #c62828;
        }

        .check-warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        .id-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .info-label {
            font-weight: 600;
            color: #555;
        }

        .age-highlight {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2e7d32;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 8px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🆔 ID Verification</h1>
            <p>Scan and verify customer IDs</p>
        </div>

        <div class="card">
            <div class="camera-section">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <div id="cameraPlaceholder" class="camera-placeholder">
                    📷 Camera will appear here
                </div>
            </div>

            <button id="startCamera" class="btn btn-primary">Start Camera</button>
            <button id="captureBtn" class="btn btn-success" disabled>Capture ID</button>
            <button id="stopCamera" class="btn btn-warning" disabled>Stop Camera</button>
        </div>

        <div class="card">
            <h3>📋 Verification Results</h3>
            <div id="result" class="result"></div>
            
            <div id="checks" class="checks" style="display: none;">
                <div class="check-item">
                    <span>Document Quality</span>
                    <span id="qualityCheck" class="check-status">Pending</span>
                </div>
                <div class="check-item">
                    <span>Security Features</span>
                    <span id="securityCheck" class="check-status">Pending</span>
                </div>
                <div class="check-item">
                    <span>Text Recognition</span>
                    <span id="textCheck" class="check-status">Pending</span>
                </div>
                <div class="check-item">
                    <span>Age Verification</span>
                    <span id="ageCheck" class="check-status">Pending</span>
                </div>
                <div class="check-item">
                    <span>Expiration Date</span>
                    <span id="expirationCheck" class="check-status">Pending</span>
                </div>
            </div>

            <div id="idInfo" class="id-info" style="display: none;">
                <h4>📄 ID Information</h4>
                <div class="info-row">
                    <span class="info-label">Name:</span>
                    <span id="nameInfo">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Date of Birth:</span>
                    <span id="dobInfo">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">State/Province:</span>
                    <span id="stateInfo">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Expiration:</span>
                    <span id="expInfo">-</span>
                </div>
                <div id="ageDisplay" class="age-highlight">Age: --</div>
            </div>
        </div>
    </div>

    <script>
        class IDVerifier {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.stream = null;
                
                // AI Configuration
                this.huggingFaceAPI = 'https://api-inference.huggingface.co/models/';
                this.ollamaAPI = 'http://localhost:11434/api/generate';
                this.useHuggingFace = true; // Set to true to use HuggingFace
                this.useOllama = false; // Set to true to use Ollama
                this.huggingFaceToken = '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';
                
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('startCamera').onclick = () => this.startCamera();
                document.getElementById('captureBtn').onclick = () => this.captureImage();
                document.getElementById('stopCamera').onclick = () => this.stopCamera();
            }

            async startCamera() {
                try {
                    const constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    
                    this.video.style.display = 'block';
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                    
                    document.getElementById('startCamera').disabled = true;
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('stopCamera').disabled = false;
                    
                } catch (error) {
                    alert('Camera access denied or not available. Please ensure you have a camera and grant permission.');
                    console.error('Camera error:', error);
                }
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.video.style.display = 'none';
                document.getElementById('cameraPlaceholder').style.display = 'flex';
                
                document.getElementById('startCamera').disabled = false;
                document.getElementById('captureBtn').disabled = true;
                document.getElementById('stopCamera').disabled = true;
            }

            captureImage() {
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                this.ctx.drawImage(this.video, 0, 0);
                
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                this.verifyID(imageData);
            }

            async verifyID(imageData) {
                // Show verification in progress
                document.getElementById('checks').style.display = 'block';
                this.resetChecks();
                
                // Convert image to base64 for API calls
                const imageBase64 = this.canvas.toDataURL('image/jpeg', 0.8);
                
                try {
                    // Run AI-powered verification
                    await this.checkDocumentQuality(imageData);
                    await this.checkSecurityFeatures(imageBase64);
                    await this.performAITextRecognition(imageBase64);
                    await this.checkAgeAndExpiration();
                    this.showFinalResult();
                } catch (error) {
                    console.error('AI Verification Error:', error);
                    this.fallbackToMockData();
                }
            }

            resetChecks() {
                const checks = ['qualityCheck', 'securityCheck', 'textCheck', 'ageCheck', 'expirationCheck'];
                checks.forEach(check => {
                    document.getElementById(check).textContent = 'Checking...';
                    document.getElementById(check).className = 'check-status check-warning';
                });
                
                document.getElementById('result').style.display = 'none';
                document.getElementById('idInfo').style.display = 'none';
            }

            checkDocumentQuality(imageData) {
                // Simulate image quality analysis
                const brightness = this.calculateBrightness(imageData);
                const sharpness = this.calculateSharpness(imageData);
                
                const qualityScore = (brightness + sharpness) / 2;
                
                const qualityCheck = document.getElementById('qualityCheck');
                if (qualityScore > 70) {
                    qualityCheck.textContent = '✓ Good';
                    qualityCheck.className = 'check-status check-pass';
                } else if (qualityScore > 40) {
                    qualityCheck.textContent = '⚠ Fair';
                    qualityCheck.className = 'check-status check-warning';
                } else {
                    qualityCheck.textContent = '✗ Poor';
                    qualityCheck.className = 'check-status check-fail';
                }
            }

            async checkSecurityFeatures(imageBase64) {
                const securityCheck = document.getElementById('securityCheck');
                securityCheck.textContent = 'Analyzing...';
                
                try {
                    let analysis;
                    
                    if (this.useHuggingFace) {
                        analysis = await this.analyzeWithHuggingFace(imageBase64);
                    } else if (this.useOllama) {
                        analysis = await this.analyzeWithOllama(imageBase64);
                    } else {
                        throw new Error('No AI service configured');
                    }
                    
                    // Process AI response for security features
                    const securityScore = this.extractSecurityScore(analysis);
                    
                    if (securityScore >= 0.7) {
                        securityCheck.textContent = '✓ AI Verified';
                        securityCheck.className = 'check-status check-pass';
                    } else if (securityScore >= 0.4) {
                        securityCheck.textContent = '⚠ AI Partial';
                        securityCheck.className = 'check-status check-warning';
                    } else {
                        securityCheck.textContent = '✗ AI Rejected';
                        securityCheck.className = 'check-status check-fail';
                    }
                } catch (error) {
                    console.error('Security check failed:', error);
                    securityCheck.textContent = '⚠ Check Failed';
                    securityCheck.className = 'check-status check-warning';
                }
            }

            async performAITextRecognition(imageBase64) {
                const textCheck = document.getElementById('textCheck');
                textCheck.textContent = 'AI Reading...';
                
                try {
                    let extractedText;
                    
                    if (this.useHuggingFace) {
                        extractedText = await this.extractTextWithHuggingFace(imageBase64);
                    } else if (this.useOllama) {
                        extractedText = await this.extractTextWithOllama(imageBase64);
                    } else {
                        throw new Error('No AI service configured');
                    }
                    
                    // Parse extracted text for ID information
                    const idData = this.parseIDText(extractedText);
                    
                    if (idData.name && idData.dob) {
                        textCheck.textContent = '✓ AI Extracted';
                        textCheck.className = 'check-status check-pass';
                        
                        // Populate ID information
                        document.getElementById('nameInfo').textContent = idData.name;
                        document.getElementById('dobInfo').textContent = idData.dob;
                        document.getElementById('stateInfo').textContent = idData.state || 'Unknown';
                        document.getElementById('expInfo').textContent = idData.expiration || 'Unknown';
                        document.getElementById('ageDisplay').textContent = `Age: ${idData.age}`;
                        
                        document.getElementById('idInfo').style.display = 'block';
                    } else {
                        throw new Error('Could not extract ID data');
                    }
                } catch (error) {
                    console.error('Text recognition failed:', error);
                    textCheck.textContent = '⚠ AI Failed';
                    textCheck.className = 'check-status check-warning';
                    
                    // Fallback to mock data
                    this.fallbackToMockData();
                }
            }

            checkAgeAndExpiration() {
                const age = parseInt(document.getElementById('ageDisplay').textContent.split(': ')[1]);
                const expDate = new Date(document.getElementById('expInfo').textContent);
                const today = new Date();
                
                // Age check
                const ageCheck = document.getElementById('ageCheck');
                if (age >= 21) {
                    ageCheck.textContent = '✓ 21+';
                    ageCheck.className = 'check-status check-pass';
                } else if (age >= 18) {
                    ageCheck.textContent = '⚠ 18-20';
                    ageCheck.className = 'check-status check-warning';
                } else {
                    ageCheck.textContent = '✗ Under 18';
                    ageCheck.className = 'check-status check-fail';
                }
                
                // Expiration check
                const expirationCheck = document.getElementById('expirationCheck');
                if (expDate > today) {
                    const monthsLeft = Math.round((expDate - today) / (1000 * 60 * 60 * 24 * 30));
                    if (monthsLeft > 6) {
                        expirationCheck.textContent = '✓ Valid';
                        expirationCheck.className = 'check-status check-pass';
                    } else {
                        expirationCheck.textContent = '⚠ Expires Soon';
                        expirationCheck.className = 'check-status check-warning';
                    }
                } else {
                    expirationCheck.textContent = '✗ Expired';
                    expirationCheck.className = 'check-status check-fail';
                }
            }

            showFinalResult() {
                const checks = document.querySelectorAll('.check-status');
                let passCount = 0;
                let failCount = 0;
                let warnCount = 0;
                
                checks.forEach(check => {
                    if (check.classList.contains('check-pass')) passCount++;
                    else if (check.classList.contains('check-fail')) failCount++;
                    else if (check.classList.contains('check-warning')) warnCount++;
                });
                
                const result = document.getElementById('result');
                result.style.display = 'block';
                
                if (failCount > 0) {
                    result.className = 'result invalid';
                    result.innerHTML = '🚫 ID REJECTED<br>Failed security checks';
                } else if (warnCount > 2) {
                    result.className = 'result warning';
                    result.innerHTML = '⚠️ VERIFY MANUALLY<br>Review required';
                } else {
                    result.className = 'result valid';
                    result.innerHTML = '✅ ID ACCEPTED<br>All checks passed';
                }
            }

            generateMockIDData() {
                const names = ['John Smith', 'Sarah Johnson', 'Michael Brown', 'Emma Davis', 'James Wilson'];
                const states = ['CA', 'NY', 'TX', 'FL', 'IL', 'PA', 'OH', 'GA', 'NC', 'MI'];
                
                const birthYear = 1980 + Math.floor(Math.random() * 25);
                const birthMonth = 1 + Math.floor(Math.random() * 12);
                const birthDay = 1 + Math.floor(Math.random() * 28);
                
                const expYear = 2025 + Math.floor(Math.random() * 8);
                
                const age = new Date().getFullYear() - birthYear;
                
                return {
                    name: names[Math.floor(Math.random() * names.length)],
                    dob: `${birthMonth.toString().padStart(2, '0')}/${birthDay.toString().padStart(2, '0')}/${birthYear}`,
                    state: states[Math.floor(Math.random() * states.length)],
                    expiration: `${birthMonth.toString().padStart(2, '0')}/${birthDay.toString().padStart(2, '0')}/${expYear}`,
                    age: age
                };
            }

            calculateBrightness(imageData) {
                const data = imageData.data;
                let brightness = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    brightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
                }
                
                return (brightness / (data.length / 4)) / 255 * 100;
            }

            calculateSharpness(imageData) {
                // Simplified sharpness calculation
                const data = imageData.data;
                const width = imageData.width;
                let sharpness = 0;
                
                for (let i = 0; i < data.length - width * 4; i += 4) {
                    const current = data[i] + data[i + 1] + data[i + 2];
                    const below = data[i + width * 4] + data[i + width * 4 + 1] + data[i + width * 4 + 2];
                    sharpness += Math.abs(current - below);
                }
                
                return Math.min((sharpness / (data.length / 4)) / 10, 100);
            }

            // ========== HUGGING FACE INTEGRATION ==========
            async analyzeWithHuggingFace(imageBase64) {
                const imageBlob = this.base64ToBlob(imageBase64);
                
                // Use object detection model for document analysis
                const response = await fetch(this.huggingFaceAPI + 'facebook/detr-resnet-50', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.huggingFaceToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: imageBlob
                });
                
                if (!response.ok) {
                    throw new Error(`HuggingFace API error: ${response.status}`);
                }
                
                return await response.json();
            }

            async extractTextWithHuggingFace(imageBase64) {
                const imageBlob = this.base64ToBlob(imageBase64);
                
                // Use OCR model for text extraction
                const response = await fetch(this.huggingFaceAPI + 'microsoft/trocr-base-printed', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.huggingFaceToken}`,
                    },
                    body: imageBlob
                });
                
                if (!response.ok) {
                    throw new Error(`HuggingFace OCR error: ${response.status}`);
                }
                
                const result = await response.json();
                return result.generated_text || result[0]?.generated_text || '';
            }

            // ========== OLLAMA INTEGRATION ==========
            async analyzeWithOllama(imageBase64) {
                const prompt = `Analyze this ID document image. Look for security features like holograms, watermarks, and overall document authenticity. Respond with a security score from 0-1 and explain your reasoning.`;
                
                const response = await fetch(this.ollamaAPI, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama3.2-vision', // or 'llava' for vision
                        prompt: prompt,
                        images: [imageBase64.split(',')[1]], // Remove data:image/jpeg;base64, prefix
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Ollama API error: ${response.status}`);
                }
                
                const result = await response.json();
                return result.response;
            }

            async extractTextWithOllama(imageBase64) {
                const prompt = `Extract all text from this ID document. Focus on finding: Name, Date of Birth (DOB), State/Province, Expiration Date, and any ID numbers. Format the response as JSON with keys: name, dob, state, expiration, id_number.`;
                
                const response = await fetch(this.ollamaAPI, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama3.2-vision',
                        prompt: prompt,
                        images: [imageBase64.split(',')[1]],
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Ollama OCR error: ${response.status}`);
                }
                
                const result = await response.json();
                return result.response;
            }

            // ========== HELPER FUNCTIONS ==========
            base64ToBlob(base64) {
                const byteCharacters = atob(base64.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: 'image/jpeg' });
            }

            extractSecurityScore(aiResponse) {
                // Parse AI response to extract security score
                const scoreMatch = aiResponse.match(/score[:\s]+([0-9.]+)/i);
                if (scoreMatch) {
                    return parseFloat(scoreMatch[1]);
                }
                
                // Fallback: analyze keywords for security features
                const securityKeywords = ['hologram', 'watermark', 'authentic', 'genuine', 'valid'];
                const suspiciousKeywords = ['fake', 'suspicious', 'tampered', 'altered', 'invalid'];
                
                let score = 0.5;
                securityKeywords.forEach(keyword => {
                    if (aiResponse.toLowerCase().includes(keyword)) score += 0.1;
                });
                suspiciousKeywords.forEach(keyword => {
                    if (aiResponse.toLowerCase().includes(keyword)) score -= 0.2;
                });
                
                return Math.max(0, Math.min(1, score));
            }

            parseIDText(extractedText) {
                try {
                    // Try to parse as JSON first (from Ollama structured response)
                    const jsonMatch = extractedText.match(/\{.*\}/s);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        return {
                            name: parsed.name,
                            dob: parsed.dob,
                            state: parsed.state,
                            expiration: parsed.expiration,
                            age: this.calculateAge(parsed.dob)
                        };
                    }
                } catch (e) {
                    // Fall back to regex parsing
                }
                
                // Regex patterns for common ID formats
                const nameMatch = extractedText.match(/(?:name|ln|last name)[:\s]+([a-z\s]+)/i);
                const dobMatch = extractedText.match(/(?:dob|birth|born)[:\s]+(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})/i);
                const stateMatch = extractedText.match(/(?:state|st)[:\s]+([a-z]{2})/i);
                const expMatch = extractedText.match(/(?:exp|expires)[:\s]+(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})/i);
                
                const dob = dobMatch ? dobMatch[1] : null;
                
                return {
                    name: nameMatch ? nameMatch[1].trim() : 'Unknown',
                    dob: dob,
                    state: stateMatch ? stateMatch[1].toUpperCase() : 'Unknown',
                    expiration: expMatch ? expMatch[1] : 'Unknown',
                    age: dob ? this.calculateAge(dob) : 0
                };
            }

            calculateAge(dobString) {
                if (!dobString) return 0;
                
                const dob = new Date(dobString);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                
                return age;
            }

            fallbackToMockData() {
                const mockData = this.generateMockIDData();
                document.getElementById('nameInfo').textContent = mockData.name;
                document.getElementById('dobInfo').textContent = mockData.dob;
                document.getElementById('stateInfo').textContent = mockData.state;
                document.getElementById('expInfo').textContent = mockData.expiration;
                document.getElementById('ageDisplay').textContent = `Age: ${mockData.age}`;
                document.getElementById('idInfo').style.display = 'block';
            }
        }

        // Initialize the app
        const app = new IDVerifier();
    </script>
</body>
</html>
